<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Sahyog Sutra ‚Äî Weaving Communities Together</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
<link rel="icon" type="image/png" href="/static/sahyog_sutra_logo.png">
</head>
<body>

<header class="navbar">
    <div class="nav-inner">
        <a href="#" class="brand" title="Sahyog Sutra">
            <img src="/static/sahyog_sutra_logo.png" alt="Sahyog Sutra Logo" style="width:44px;height:44px;border-radius:8px;object-fit:cover;box-shadow:0 4px 12px rgba(215,106,30,0.35);">
            <div class="brand-text">
                <div>{{ translate('Sahyog Sutra') }}</div>
                <div>{{ translate('Weaving Communities Together') }}</div>
            </div>
        </a>
        <nav>
            <a class="navlink active" href="#home" data-section="home">{{ translate("Home") }}</a>
            <a class="navlink" href="#campaigns" data-section="campaigns">{{ translate("Campaigns") }}</a>
            <a class="navlink" href="#add" data-section="add">{{ translate("Add") }}</a>
            {% if isadmin %}
            <a class="navlink" href="#pending" data-section="pending">{{ translate("Pending") }}</a>
            {% endif %}
            <a class="navlink" href="#contact" data-section="contact">{{ translate("Contact") }}</a>
            <div class="language-selector" style="position: relative;">
                <button class="cta" id="languageBtn" style="margin: 0;">{{ translate("Change Language") }}</button>
                <div id="languageDropdown" class="language-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: var(--bg-light); border: 1px solid var(--border-color); border-radius: 8px; min-width: 220px; z-index: 1001; margin-top: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <div class="lang-option" data-lang="en">English / English (en)</div>
                    <div class="lang-option" data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä / Hindi (hi)</div>
                    <div class="lang-option" data-lang="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å / Telugu (te)</div>
                    <div class="lang-option" data-lang="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° / Kannada (kn)</div>
                    <div class="lang-option" data-lang="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç / Malayalam (ml)</div>
                    <div class="lang-option" data-lang="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä / Gujarati (gu)</div>
                    <div class="lang-option" data-lang="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ / Bengali (bn)</div>
                    <div class="lang-option" data-lang="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä / Punjabi (pa)</div>
                    <div class="lang-option" data-lang="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä / Marathi (mr)</div>
                    <div class="lang-option" data-lang="or">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü / Odia (or)</div>
                </div>
            </div>
        </nav>
    </div>
</header>

<div id="alertBar" class="alert-bar">
    <div class="alert-content">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex: 1;">
            <span class="alert-text" id="alertText"></span>
            <div class="alert-buttons" id="alertButtons" style="display: none; gap: 10px;">
                <button class="alert-action-btn reload-btn" onclick="window.location.reload()" title="{{ translate('Reload') }}">{{ translate('Click here to reload') }}</button>
                <button class="alert-action-btn close-btn" onclick="closeAlert()" title="{{ translate('Close') }}">{{ translate('Close this message') }}</button>
            </div>
        </div>
    </div>
    <button class="alert-close" id="alertCloseBtn" onclick="closeAlert()" title="{{ translate('Close') }}">‚úï</button>
</div>

<div id="sideChatDrawer" class="chat-drawer">
    <div class="chat-header">
        <h3>{{ translate("Event Chat") }}</h3>
        <button class="close-chat" onclick="closeEventChat()">√ó</button>
    </div>
    <iframe id="globalChatIframe" class="chat-iframe"></iframe>
</div>

<main>
    <section id="home" class="active">
        <div class="home-layout">
            <div class="home-hero">
                <h1>{{ translate("Hey") }} {{ translate(fullname.split()[0], save_file=False) }}, {{ translate("Welcome to") }} <span class="brand-highlight">{{ translate("Sahyog Sutra") }} !</span></h1>
                <p>{{ translate("Unite, act, and create change. Join a campaign, volunteer your time, or start a movement ‚Äî every effort weaves a stronger community.") }}</p>
                <div class="sutra-divider"><span>‡§∏‡§π‡§Ø‡•ã‡§ó ‡§∏‡•Ç‡§§‡•ç‡§∞</span></div>
                <div id="ndhome"></div>
                <script>
                // FIX: Use relative path to avoid Mixed Content error
                fetch("/static/quotes.json").then(r=>r.json()).then(data=>{
                    const userLanguage = "{{ user_language }}" || "en";
                    const quoteEl = document.getElementById('ndhome');
                    const setQuote = () => {
                        const quoteKeys = Object.keys(data);
                        const randomQuoteKey = quoteKeys[Math.floor(Math.random() * quoteKeys.length)];
                        const quoteText = data[randomQuoteKey][userLanguage] || data[randomQuoteKey]["en"];
                        quoteEl.innerText = `{{ translate("Active Campaigns:") }} {{ active_events_length }}\n\n"${quoteText}"`;
                    }; setQuote(); setInterval(setQuote, 6000); });
                </script>
                {% if top_organizers %}
                <div class="dash-card" style="margin-top: 2rem;">
                    <h4>üèÜ {{ translate("Top Organizers") }}</h4>
                    <ul class="leaderboard-list">
                        {% for org in top_organizers %}
                        <li class="leaderboard-item">
                            <span class="leaderboard-rank">#{{ loop.index }}</span>
                            <img src="https://ui-avatars.com/api/?name={{ org.username }}&background=random&color=fff&size=128" class="leaderboard-avatar">
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 0.9rem;">{{ org.name }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">{{ org.count }} {{ translate("Events") }}</div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            <div class="account-container">
                {% if c_user == "None" %}
                    <div class="toggle-buttons">
                        <button id="login-tab-btn" class="active">{{ translate("Login") }}</button>
                        <button id="signup-tab-btn">{{ translate("Sign Up") }}</button>
                    </div>
                    <form class="auth-form active" id="loginpage">
                        <div class="form-group">
                            <input type="text" name="loginusername" placeholder="{{ translate('Username or Email') }}" required />
                        </div>
                        <div class="form-group">
                            <input type="password" name="loginpassword" id="loginpassword" placeholder="{{ translate('Password') }}" required/>
                            <span class="toggle-password" onclick="togglePasswordVisibility('loginpassword')">üëÅÔ∏è</span>
                        </div>
                        <div class="forget-link-container">
                             <button type="button" id="forget-pass-link" class="forget-link">{{ translate("Forgot Password?") }}</button>
                        </div>
                        <button type="submit" class="submit-btn">{{ translate("Login") }}</button>
                    </form>
                    <form class="auth-form" id="signuppage">
                        <div class="form-group"><input type="text" name="nameofuser" placeholder="{{ translate('Full Name') }}" maxlength="24" required /></div>
                        <div class="form-group"><input type="text" name="username" placeholder="{{ translate('Username') }}" maxlength="20" required /></div>
                        <div class="form-group otp-group">
                           <input type="email" name="email" id="email" placeholder="{{ translate('Email') }}" required />
                           <button type="button" id="sendOtpBtn" class="otp-btn">{{ translate("Send OTP") }}</button>
                        </div>
                        <div class="form-group"><input type="number" name="signupotp" placeholder="{{ translate('Enter OTP') }}" oninput="this.value=this.value.slice(0,4)" required /></div>
                        <div class="form-group">
                            <input type="password" name="password" id="signup_password" placeholder="{{ translate('Password') }}" required />
                            <span class="toggle-password" onclick="togglePasswordVisibility('signup_password')">üëÅÔ∏è</span>
                        </div>
                        <div class="form-group">
                            <input type="password" name="cpassword" id="signup_cpassword" placeholder="{{ translate('Confirm Password') }}" required />
                            <span class="toggle-password" onclick="togglePasswordVisibility('signup_cpassword')">üëÅÔ∏è</span>
                        </div>
                        <button type="submit" class="submit-btn">{{ translate("Sign Up") }}</button>
                    </form>
                    <form class="auth-form" id="forgetpasswordpage">
                        <h3 style="text-align: center;">{{ translate("Reset Password") }}</h3>
                        <div class="form-group">
                            <input type="text" name="forgetemail" id="forgetemail" placeholder="{{ translate('Enter your email or username') }}" required />
                        </div>
                        <button type="button" id="sendForgetOtpBtn" class="submit-btn" style="margin-bottom: 1rem;">{{ translate("Send OTP") }}</button>

                        <div id="forget-step-2" style="display:none;">
                            <div class="form-group">
                                <input type="number" name="forgetotp" placeholder="{{ translate('Enter OTP') }}" oninput="this.value=this.value.slice(0,4)" required />
                            </div>
                            <div class="form-group">
                                <input type="password" name="newpassword" id="newpassword" placeholder="{{ translate('New Password') }}" required />
                                <span class="toggle-password" onclick="togglePasswordVisibility('newpassword')">üëÅÔ∏è</span>
                            </div>
                            <div class="form-group">
                                <input type="password" name="confirmnewpassword" id="confirmnewpassword" placeholder="{{ translate('Confirm New Password') }}" required />
                                <span class="toggle-password" onclick="togglePasswordVisibility('confirmnewpassword')">üëÅÔ∏è</span>
                            </div>
                            <button type="submit" class="submit-btn">{{ translate("Reset Password") }}</button>
                        </div>
                        <div class="back-btn-container">
                            <button type="button" class="read-more-btn" id="backToLoginBtn">{{ translate("Back to Login") }}</button>
                        </div>
                    </form>
                {% else %}
                    <h3>{{ translate("Welcome") }}, {{ translate(fullname, save_file=False) }}!</h3>
                    <p>{{ translate("Username:") }} {{ c_user }}</p>
                    <p>{{ translate("Email:") }} {{ userdetails['email'] }}</p>
                    {% if userdetails['events'] != None %}
                    <p>{{ translate("Events: Total") }} {{ userdetails['events'].split(",") | length }} {{ translate("Events added by you.") }} </p>
                    <button class="otp-btn" onclick="viewyourevents('{{ c_user }}')">{{ translate("Click Here To View Your Events") }}</button>
                    {% else %}
                    <p>{{ translate("Events by you: No event added by you yet.") }}</p>
                    {% endif %}
                    <div class="form-buttons">
                        <button onclick="window.location.href='/user/{{ c_user }}'" class="submit-btn">{{ translate("View Profile") }}</button>
                        <button onclick="window.location.href='/clearsession';" class="delete-btn">{{ translate("Logout") }}</button>
                    </div>
                {% endif %}
            </div>
        </div>
        {% if isadmin %}
        <div style="margin-top: 3rem;">
            <h2>üõ†Ô∏è System Health (Admin)</h2>
            <div class="dashboard-grid">
                <div class="dash-card"><h3>{{ admin_stats['total_users'] }}</h3><p>Total Users</p></div>
                <div class="dash-card"><h3>{{ admin_stats['total_events'] }}</h3><p>Total Events</p></div>
                <div class="dash-card"><h3>{{ admin_stats['pending_requests'] }}</h3><p>Pending Requests</p></div>
                <div class="dash-card"><h3>{{ admin_stats['active_threads'] }}</h3><p>Active Threads</p></div>
            </div>
        </div>
        {% endif %}
    </section>

    <section id="campaigns">
        <div class="campaign-header">
            <div>
                <h2 id="campaignsTitle">{{ translate("Campaigns") }} ( {{ active_events_length }} )</h2>
                <p>{{ translate("Find campaigns to join or create your own.") }}</p>
            </div>
            <div class="toggle-buttons">
                <button id="listViewBtn" class="active" onclick="toggleView('list')">List View</button>
                <button id="calendarViewBtn" onclick="toggleView('calendar')">Calendar View</button>
            </div>
        </div>
        <div id="campaignsLoadingState" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Loading campaigns...") }}</p>
        </div>
        <div id="campaignsContent" style="display: none;"></div>
        <div id="calendarView" style="display: none;">
            <div id="calendar"></div>
        </div>
    </section>

    <section id="pending">
        {% if isadmin %}
        <div id="pendingLoadingState" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Loading pending events...") }}</p>
        </div>
        <div id="pendingContent" style="display: none;"></div>
        {% else %}
        <div style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Access denied. Admin privileges required.") }}</p>
        </div>
        {% endif %}
    </section>

    <section id="add">
        <div id="addFormLoadingState" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Loading form...") }}</p>
        </div>
        <div id="addFormContent" style="display: none;"></div>
    </section>

    <section id="contact">
        <div class="form-container">
            <h1>{{ translate("Contact Us") }}</h1>
            <p class="intro">
                {{ translate("Have a question, suggestion, or want to collaborate? We'd love to hear from you. Email us at: ") }} <a href="mailto:hu1243009@sjchs.edu.in">hu1243009@sjchs.edu.in</a></span></a>
            </p>
        </div>
    </section>
</main>

<script>
    window.SAHYOG_CONFIG = {
        currentUser: "{{ c_user }}",
        userLanguage: "{{ user_language }}",
        activeEventsLength: "{{ active_events_length }}",
        trans: {
            declineReason: "{{ translate('A reason is required to decline this event:') }}",
            declineCancelled: "{{ translate('Decline action cancelled.') }}",
            areYouSure: "{{ translate('Are you sure?') }}",
            loginForAI: "{{ translate('To avoid spam, we recommend you to please login before generating AI description.') }}",
            fillFieldsAI: "{{ translate('Please fill in ALL fields (Name, Location, Category, Dates, Times) before generating.') }}",
            generating: "{{ translate('Generating the descriptions please wait some seconds...') }}",
            formal: "{{ translate('Formal') }}",
            informal: "{{ translate('Informal') }}",
            promotional: "{{ translate('Promotional') }}",
            entertaining: "{{ translate('Entertaining') }}",
            descUpdated: "{{ translate('Description updated!') }}",
            aiFailed: "{{ translate('Failed to generate descriptions. Please try again.') }}",
            loadFailed: "{{ translate('Failed to load content. Please try again.') }}",
            retry: "{{ translate('Retry') }}",
            processing: "{{ translate('Processing...') }}",
            errorOccurred: "{{ translate('An error occurred.') }}",
            enterValidEmail: "{{ translate('Please enter a valid email address.') }}",
            sending: "{{ translate('Sending...') }}",
            sendOtp: "{{ translate('Send OTP') }}",
            fillAllFields: "{{ translate('Please fill in all fields.') }}",
            passwordMismatch: "{{ translate('Passwords do not match.') }}",
            changingLangTo: "{{ translate('Please wait changing language to ') }}",
            langChangedTo: "{{ translate('Language changed to ') }}",
            reloadMsg: "{{ translate('If not changed please try to reload the page or click the button below to reload!') }}",
            langChangeError: "{{ translate('Could not change language right now. Please try again.') }}"
        }
    };

    // --- Specific Jinja-Dependent Logic (Keep here or move to a separate partial) ---
    // This logic is too tightly coupled to Jinja loops/logic to easily move without complex refactoring

    // Quotes Logic
    fetch("/static/quotes.json").then(r=>r.json()).then(data=>{
        const userLanguage = SAHYOG_CONFIG.userLanguage || "en";
        const quoteEl = document.getElementById('ndhome');
        if(!quoteEl) return;
        const setQuote = () => {
            const quoteKeys = Object.keys(data);
            const randomQuoteKey = quoteKeys[Math.floor(Math.random() * quoteKeys.length)];
            const quoteText = data[randomQuoteKey][userLanguage] || data[randomQuoteKey]["en"];
            quoteEl.innerText = `{{ translate("Active Campaigns:") }} ${SAHYOG_CONFIG.activeEventsLength}\n\n"${quoteText}"`;
        };
        setQuote();
        setInterval(setQuote, 6000);
    });
</script>

<!-- Load the external script -->
<script src="/static/script.js"></script>
</body>
</html>
